# Модули бота

## Ответственность
- `config.ts`: загрузка и валидация переменных окружения.
- `message-handler.ts`: обработка входящих сообщений в группе и применение санкций.
- `callback-handler.ts`: обработка админских callback-кнопок.
- `message-repository.ts`: операции с таблицей сообщений в Supabase.
- `moderation-repository.ts`: операции с таблицами нарушений и ежедневной статистики.
- `moderation-policy.ts`: правила санкций по числу нарушений.
- `moderation-state.ts`: in-memory состояние только для pending-режима согласования.
- `utils.ts`, `constants.ts`, `logger.ts`: общие утилиты и константы.

## Входы/выходы
- Вход: `grammy` контекст, конфиг окружения, клиент Supabase.
- Выход: зарегистрированные обработчики событий бота и побочные эффекты (удаление/предупреждение/бан/логирование).

## Политика санкций
- 1-е нарушение: удаление сообщения.
- 2-е нарушение: удаление + предупреждение (автоудаление предупреждения по таймеру).
- 3-е и далее: удаление + бан.

## Антифлуд
- Используется плагин `@grammyjs/ratelimiter`.
- Превышение лимита удаляет сообщение и фиксируется в суточной статистике.

## Ограничения производительности
- Лишние запросы в БД исключены из обходных веток.
- Очистка старых нарушений запускается по таймеру раз в час.

## Частые ошибки
- Не созданы таблицы `format_violations` и `moderation_daily_stats` в Supabase.
- Некорректный `parse_mode: HTML`, если не экранировать имя участника.
- Изменение порогов без синхронизации `WARNING_AT_VIOLATION` и `BAN_AT_VIOLATION`.
